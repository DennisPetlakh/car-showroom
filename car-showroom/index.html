<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Car Showroom</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="module">
    import React, { useState, useRef } from 'https://esm.sh/react@18';
    import ReactDOM from 'https://esm.sh/react-dom@18/client';
    import { Upload, Download, X } from 'https://esm.sh/lucide-react@0.263.1';

    function App() {
      const [originalImage, setOriginalImage] = useState(null);
      const [processedImage, setProcessedImage] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const fileInputRef = useRef(null);
      const canvasRef = useRef(null);

      const API_ENDPOINT = '/api/remove-bg';

      const createShowroomBackground = (width, height) => {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        const floorGradient = ctx.createLinearGradient(0, height * 0.6, 0, height);
        floorGradient.addColorStop(0, '#f8f8f8');
        floorGradient.addColorStop(1, '#e0e0e0');

        const backdropGradient = ctx.createLinearGradient(0, 0, 0, height * 0.6);
        backdropGradient.addColorStop(0, '#ffffff');
        backdropGradient.addColorStop(1, '#f5f5f5');

        ctx.fillStyle = backdropGradient;
        ctx.fillRect(0, 0, width, height * 0.6);

        ctx.fillStyle = floorGradient;
        ctx.fillRect(0, height * 0.6, width, height * 0.4);

        const lightGradient = ctx.createRadialGradient(
          width / 2, height * 0.3, 0,
          width / 2, height * 0.3, width * 0.6
        );
        lightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.5)');
        lightGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = lightGradient;
        ctx.fillRect(0, 0, width, height);

        ctx.strokeStyle = 'rgba(200, 200, 200, 0.3)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, height * 0.6);
        ctx.lineTo(width, height * 0.6);
        ctx.stroke();

        return canvas;
      };

      const removeBackground = async (file) => {
        const base64Image = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve(base64);
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            image_base64: base64Image
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to remove background');
        }

        const data = await response.json();
        const binaryString = atob(data.image_base64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        const blob = new Blob([bytes], { type: 'image/png' });
        return blob;
      };

      const processImage = async (file) => {
        setLoading(true);
        setError(null);
        setProcessedImage(null);

        try {
          const noBgBlob = await removeBackground(file);
          const noBgUrl = URL.createObjectURL(noBgBlob);
          const carImg = new Image();
          
          carImg.onload = () => {
            const canvas = canvasRef.current;
            canvas.width = carImg.width;
            canvas.height = carImg.height;
            const ctx = canvas.getContext('2d');

            const showroom = createShowroomBackground(carImg.width, carImg.height);
            ctx.drawImage(showroom, 0, 0);

            const shadowGradient = ctx.createRadialGradient(
              carImg.width / 2, carImg.height * 0.85, 0,
              carImg.width / 2, carImg.height * 0.85, carImg.width * 0.35
            );
            shadowGradient.addColorStop(0, 'rgba(0, 0, 0, 0.25)');
            shadowGradient.addColorStop(0.5, 'rgba(0, 0, 0, 0.1)');
            shadowGradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            ctx.fillStyle = shadowGradient;
            ctx.fillRect(0, carImg.height * 0.7, carImg.width, carImg.height * 0.3);

            ctx.drawImage(carImg, 0, 0);

            setProcessedImage(canvas.toDataURL('image/png'));
            setLoading(false);
            URL.revokeObjectURL(noBgUrl);
          };

          carImg.src = noBgUrl;
        } catch (err) {
          setError(err.message || 'Failed to process image');
          setLoading(false);
        }
      };

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            setOriginalImage(e.target.result);
            processImage(file);
          };
          reader.readAsDataURL(file);
        } else {
          setError('Please upload a valid image file');
        }
      };

      const handleDownload = () => {
        const link = document.createElement('a');
        link.download = 'car-showroom.png';
        link.href = processedImage;
        link.click();
      };

      const handleReset = () => {
        setOriginalImage(null);
        setProcessedImage(null);
        setError(null);
        if (fileInputRef.current) {
          fileInputRef.current.value = '';
        }
      };

      return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-8' },
        React.createElement('div', { className: 'max-w-6xl mx-auto' },
          React.createElement('div', { className: 'text-center mb-8' },
            React.createElement('h1', { className: 'text-4xl font-bold text-gray-900 mb-2' }, 'Car Showroom Background Replacer'),
            React.createElement('p', { className: 'text-gray-600' }, 'Upload a car photo and transform it with professional showroom lighting')
          ),
          error && React.createElement('div', { className: 'mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg' }, error),
          !originalImage ? 
            React.createElement('div', { className: 'bg-white rounded-xl shadow-lg p-12' },
              React.createElement('label', { htmlFor: 'file-upload', className: 'flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-gray-300 rounded-lg p-12 hover:border-blue-500 transition-colors' },
                React.createElement(Upload, { className: 'w-16 h-16 text-gray-400 mb-4' }),
                React.createElement('span', { className: 'text-lg font-medium text-gray-700 mb-2' }, 'Click to upload car photo'),
                React.createElement('span', { className: 'text-sm text-gray-500' }, 'PNG, JPG, or WEBP'),
                React.createElement('input', { id: 'file-upload', ref: fileInputRef, type: 'file', className: 'hidden', accept: 'image/*', onChange: handleFileUpload })
              )
            ) :
            React.createElement('div', { className: 'space-y-6' },
              React.createElement('div', { className: 'grid md:grid-cols-2 gap-6' },
                React.createElement('div', { className: 'bg-white rounded-xl shadow-lg p-6' },
                  React.createElement('h2', { className: 'text-xl font-semibold mb-4 text-gray-800' }, 'Original'),
                  React.createElement('img', { src: originalImage, alt: 'Original car', className: 'w-full rounded-lg' })
                ),
                React.createElement('div', { className: 'bg-white rounded-xl shadow-lg p-6' },
                  React.createElement('h2', { className: 'text-xl font-semibold mb-4 text-gray-800' }, 'Showroom Result'),
                  loading ? 
                    React.createElement('div', { className: 'flex flex-col items-center justify-center h-64 gap-4' },
                      React.createElement('div', { className: 'animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600' }),
                      React.createElement('p', { className: 'text-gray-600 text-sm' }, 'Processing...')
                    ) :
                    processedImage && React.createElement('img', { src: processedImage, alt: 'Processed car', className: 'w-full rounded-lg' })
                )
              ),
              React.createElement('div', { className: 'flex justify-center gap-4' },
                React.createElement('button', { onClick: handleDownload, disabled: !processedImage, className: 'flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50' },
                  React.createElement(Download, { className: 'w-5 h-5' }),
                  'Download Result'
                ),
                React.createElement('button', { onClick: handleReset, className: 'flex items-center gap-2 bg-gray-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-gray-700 transition-colors' },
                  React.createElement(X, { className: 'w-5 h-5' }),
                  'Upload New Photo'
                )
              )
            ),
          React.createElement('canvas', { ref: canvasRef, className: 'hidden' })
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>